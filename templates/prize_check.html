<!-- templates/prize_check.html -->
<!-- 版本: 1.2.1 - 对奖结果显示回报率 -->
{% extends "base.html" %}
{% from "components/lottery_balls.html" import display_balls %}

{% block title %}对奖中心{% endblock %}

{% block head %}
<style>
    .ball-selector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 5px;
        margin-bottom: 15px;
    }
    .ball-selector-grid .ball {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        transition: all 0.2s ease-in-out;
    }
    .ball-selector-grid .ball.selected-red {
        background-color: #dc3545; /* Red */
        color: white;
        border-color: #dc3545;
    }
    .ball-selector-grid .ball.selected-blue {
        background-color: #0d6efd; /* Blue */
        color: white;
        border-color: #0d6efd;
    }
    .ball-selector-grid .ball:hover:not(.selected-red):not(.selected-blue) {
        background-color: #e9ecef;
    }
    .selected-balls-display {
        min-height: 60px;
        border: 1px dashed #ccc;
        padding: 10px;
        border-radius: 5px;
        background-color: #f0f0f0;
        margin-bottom: 15px;
    }
    .candidate-entry {
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        background-color: #fff;
    }
    .candidate-entry .ball-container {
        margin-bottom: 5px;
    }
    .fun-game-progress {
        margin-top: 15px;
        display: none; /* 默认隐藏 */
    }
    .fun-game-tip {
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">对奖中心</h1>

<div class="alert alert-info text-center" role="alert">
    输入您的彩票号码，核对历史中奖情况，或参与趣味游戏。
</div>

<div class="card mb-4">
    <div class="card-header">选择彩票类型</div>
    <div class="card-body">
        <div class="mb-3">
            <a href="#" class="btn btn-danger active me-2" id="ssq_check_tab">双色球</a>
            <a href="#" class="btn btn-primary" id="dlt_check_tab">大乐透</a>
        </div>
    </div>
</div>

<div id="ssq_check_section" class="lottery-check-section">
    <h2 class="mb-3">双色球对奖</h2>

    <div class="card mb-4">
        <div class="card-header">输入您的号码</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">红球 (1-33, 可选任意数量)</label>
                <div class="ball-selector-grid" id="ssq_red_selector">
                    {% for i in range(1, 34) %}
                    <div class="ball" data-ball-type="red" data-ball-value="{{ i }}">{{ '%02d' | format(i) }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">蓝球 (1-16, 可选任意数量)</label>
                <div class="ball-selector-grid" id="ssq_blue_selector">
                    {% for i in range(1, 17) %}
                    <div class="ball" data-ball-type="blue" data-ball-value="{{ i }}">{{ '%02d' | format(i) }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">当前选择的号码:</label>
                <div class="selected-balls-display" id="ssq_selected_display">
                    <p class="text-muted">红球: <span id="ssq_selected_red"></span></p>
                    <p class="text-muted">蓝球: <span id="ssq_selected_blue"></span></p>
                </div>
            </div>
            <button class="btn btn-success me-2" id="ssq_add_to_candidates">添加到对奖列表</button>
            <button class="btn btn-secondary" id="ssq_clear_selection">清空选择</button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">待对奖号码列表 (最多 {{ prediction_generated_count }} 组)</div>
        <div class="card-body">
            <div id="ssq_candidate_list">
                <p class="text-muted">请从上方选择号码并添加到列表。</p>
            </div>
            <hr>
            <div class="mb-3 row align-items-center">
                <div class="col-sm-6">
                    <label for="ssq_check_range" class="col-form-label">
                        {% if ssq_latest_info %}
                            最新开奖: {{ ssq_latest_info.draw_date }} 第 {{ ssq_latest_info.issue }} 期<br>
                        {% endif %}
                        对奖历史期数往前 <span id="ssq_check_range_display">{{ prize_check_range }}</span> 期:
                    </label>
                </div>
                <div class="col-sm-6 d-flex align-items-center">
                    <input type="range" class="form-range" id="ssq_check_range" min="1" max="{{ ssq_total_draws }}" value="{{ prize_check_range }}">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-sm-6">
                    <button class="btn btn-primary w-100" id="ssq_check_prizes">核对中奖</button>
                </div>
                <div class="col-sm-6">
                    <button class="btn btn-outline-danger w-100" id="ssq_clear_prize_results">清空对奖结果</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">对奖结果</div>
        <div class="card-body" id="ssq_prize_results">
            <p class="text-muted">点击“核对中奖”按钮查看结果。</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">趣味游戏：大奖时光机</div>
        <div class="card-body">
            <p class="fun-game-tip" id="ssq_fun_game_tip">
                请从上方选择号码并添加到列表，列表中的第一个号码将用于趣味游戏。<br>
                看看这个号码多久能中一等奖！请准备好，时间正在流逝，大奖扑面而来！
            </p>
            <button class="btn btn-info" id="ssq_fun_game_start">大奖时光机</button>
            <div class="fun-game-progress" id="ssq_fun_game_progress">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <p class="mt-2 text-muted" id="ssq_fun_game_status">正在模拟第 0 期...</p>
            </div>
            <div class="mt-3" id="ssq_fun_game_results">
                <p class="text-muted">游戏结果将在此处显示。</p>
            </div>
        </div>
    </div>
</div>

<div id="dlt_check_section" class="lottery-check-section" style="display: none;">
    <h2 class="mb-3">大乐透对奖</h2>

    <div class="card mb-4">
        <div class="card-header">输入您的号码</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">红球 (1-35, 可选任意数量)</label>
                <div class="ball-selector-grid" id="dlt_red_selector">
                    {% for i in range(1, 36) %}
                    <div class="ball" data-ball-type="red" data-ball-value="{{ i }}">{{ '%02d' | format(i) }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">蓝球 (1-12, 可选任意数量)</label>
                <div class="ball-selector-grid" id="dlt_blue_selector">
                    {% for i in range(1, 13) %}
                    <div class="ball" data-ball-type="blue" data-ball-value="{{ i }}">{{ '%02d' | format(i) }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">当前选择的号码:</label>
                <div class="selected-balls-display" id="dlt_selected_display">
                    <p class="text-muted">红球: <span id="dlt_selected_red"></span></p>
                    <p class="text-muted">蓝球: <span id="dlt_selected_blue"></span></p>
                </div>
            </div>
            <button class="btn btn-success me-2" id="dlt_add_to_candidates">添加到对奖列表</button>
            <button class="btn btn-secondary" id="dlt_clear_selection">清空选择</button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">待对奖号码列表 (最多 {{ prediction_generated_count }} 组)</div>
        <div class="card-body">
            <div id="dlt_candidate_list">
                <p class="text-muted">请从上方选择号码并添加到列表。</p>
            </div>
            <hr>
            <div class="mb-3 row align-items-center">
                <div class="col-sm-6">
                    <label for="dlt_check_range" class="col-form-label">
                        {% if dlt_latest_info %}
                            最新开奖: {{ dlt_latest_info.draw_date }} 第 {{ dlt_latest_info.issue }} 期<br>
                        {% endif %}
                        对奖历史期数往前 <span id="dlt_check_range_display">{{ prize_check_range }}</span> 期:
                    </label>
                </div>
                <div class="col-sm-6 d-flex align-items-center">
                    <input type="range" class="form-range" id="dlt_check_range" min="1" max="{{ dlt_total_draws }}" value="{{ prize_check_range }}">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-sm-6">
                    <button class="btn btn-primary w-100" id="dlt_check_prizes">核对中奖</button>
                </div>
                <div class="col-sm-6">
                    <button class="btn btn-outline-danger w-100" id="dlt_clear_prize_results">清空对奖结果</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">对奖结果</div>
        <div class="card-body" id="dlt_prize_results">
            <p class="text-muted">点击“核对中奖”按钮查看结果。</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">趣味游戏：大奖时光机</div>
        <div class="card-body">
            <p class="fun-game-tip" id="dlt_fun_game_tip">
                请从上方选择号码并添加到列表，列表中的第一个号码将用于趣味游戏。<br>
                看看这个号码多久能中一等奖！请准备好，时间正在流逝，大奖扑面而来！
            </p>
            <button class="btn btn-info" id="dlt_fun_game_start">大奖时光机</button>
            <div class="fun-game-progress" id="dlt_fun_game_progress">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <p class="mt-2 text-muted" id="dlt_fun_game_status">正在模拟第 0 期...</p>
            </div>
            <div class="mt-3" id="dlt_fun_game_results">
                <p class="text-muted">游戏结果将在此处显示。</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Function to calculate combination cost (replicated from Python for frontend display)
    function combinations(n, k) {
        if (k < 0 || k > n) {
            return 0;
        }
        if (k === 0 || k === n) {
            return 1;
        }
        if (k > n / 2) {
            k = n - k;
        }
        let res = 1;
        for (let i = 0; i < k; i++) {
            res = res * (n - i) / (i + 1);
        }
        return res;
    }

    function calculateCombinationCost(userRedBallsCount, userBlueBallsCount, lotteryType) {
        let redBets, blueBets;
        if (lotteryType === 'ssq') {
            redBets = combinations(userRedBallsCount, 6);
            blueBets = combinations(userBlueBallsCount, 1);
        } else if (lotteryType === 'dlt') {
            redBets = combinations(userRedBallsCount, 5);
            blueBets = combinations(userBlueBallsCount, 2);
        } else {
            return { total_bets: 0, total_cost: 0 };
        }
        const totalBets = redBets * blueBets;
        const totalCost = totalBets * {{ per_bet_price }}; // 使用从后端传递的每注价格
        return { total_bets: totalBets, total_cost: totalCost };
    }


    // JavaScript for tab switching
    document.getElementById('ssq_check_tab').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('ssq_check_section').style.display = 'block';
        document.getElementById('dlt_check_section').style.display = 'none';
        this.classList.add('active');
        document.getElementById('dlt_check_tab').classList.remove('active');
    });

    document.getElementById('dlt_check_tab').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('dlt_check_section').style.display = 'block';
        document.getElementById('ssq_check_section').style.display = 'none';
        this.classList.add('active');
        document.getElementById('ssq_check_tab').classList.remove('active');
    });

    // Function to render lottery balls (replicated from Jinja macro for JS use)
    function renderBalls(balls, ballType) {
        let html = '';
        const sortedBalls = [...balls].sort((a, b) => a - b);
        for (const ball of sortedBalls) {
            html += `<span class="lottery-ball ball-${ballType}">${String(ball).padStart(2, '0')}</span>`;
        }
        return html;
    }

    // Generic ball selector logic
    function setupBallSelector(lotteryType, redRange, blueRange) {
        let selectedRedBalls = new Set();
        let selectedBlueBalls = new Set();
        const redSelector = document.getElementById(`${lotteryType}_red_selector`);
        const blueSelector = document.getElementById(`${lotteryType}_blue_selector`);
        const selectedDisplay = document.getElementById(`${lotteryType}_selected_display`);
        const selectedRedSpan = document.getElementById(`${lotteryType}_selected_red`);
        const selectedBlueSpan = document.getElementById(`${lotteryType}_selected_blue`);
        const candidateList = document.getElementById(`${lotteryType}_candidate_list`);
        const addToCandidatesBtn = document.getElementById(`${lotteryType}_add_to_candidates`);
        const clearSelectionBtn = document.getElementById(`${lotteryType}_clear_selection`);

        function updateDisplay() {
            selectedRedSpan.innerHTML = renderBalls(Array.from(selectedRedBalls), 'red');
            selectedBlueSpan.innerHTML = renderBalls(Array.from(selectedBlueBalls), 'blue');
        }

        function toggleBall(ballElement, ballType, selectedSet) {
            const value = parseInt(ballElement.dataset.ballValue);
            const className = `selected-${ballType}`;

            if (ballElement.classList.contains(className)) {
                ballElement.classList.remove(className);
                selectedSet.delete(value);
            } else {
                ballElement.classList.add(className);
                selectedSet.add(value);
            }
            updateDisplay();
        }

        redSelector.addEventListener('click', function(e) {
            if (e.target.classList.contains('ball')) {
                toggleBall(e.target, 'red', selectedRedBalls);
            }
        });

        blueSelector.addEventListener('click', function(e) {
            if (e.target.classList.contains('ball')) {
                toggleBall(e.target, 'blue', selectedBlueBalls);
            }
        });

        clearSelectionBtn.addEventListener('click', function() {
            selectedRedBalls.clear();
            selectedBlueBalls.clear();
            redSelector.querySelectorAll('.ball').forEach(b => b.classList.remove('selected-red'));
            blueSelector.querySelectorAll('.ball').forEach(b => b.classList.remove('selected-blue'));
            updateDisplay();
        });

        addToCandidatesBtn.addEventListener('click', function() {
            if (selectedRedBalls.size === 0 && selectedBlueBalls.size === 0) {
                alert('请至少选择一个红球或一个蓝球。');
                return;
            }

            const currentCandidates = candidateList.querySelectorAll('.candidate-entry').length;
            if (currentCandidates >= {{ prediction_generated_count }}) { // Use prediction_generated_count as max candidates
                alert(`最多只能添加 {{ prediction_generated_count }} 组号码。`);
                return;
            }

            const redArr = Array.from(selectedRedBalls).sort((a, b) => a - b);
            const blueArr = Array.from(selectedBlueBalls).sort((a, b) => a - b);

            const newEntry = document.createElement('div');
            newEntry.classList.add('candidate-entry');
            newEntry.innerHTML = `
                <p>红球: ${renderBalls(redArr, 'red')}</p>
                <p>蓝球: ${renderBalls(blueArr, 'blue')}</p>
                <input type="hidden" name="candidate_red_balls" value="${redArr.join(',')}">
                <input type="hidden" name="candidate_blue_balls" value="${blueArr.join(',')}">
                <button type="button" class="btn btn-sm btn-danger remove-candidate-btn">移除</button>
            `;
            candidateList.appendChild(newEntry);

            // Clear selection after adding
            clearSelectionBtn.click();
            if (candidateList.querySelector('p.text-muted')) {
                candidateList.querySelector('p.text-muted').remove();
            }
            // 更新趣味游戏提示
            updateFunGameTip(lotteryType);
        });

        candidateList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-candidate-btn')) {
                e.target.closest('.candidate-entry').remove();
                if (candidateList.children.length === 0) {
                    candidateList.innerHTML = '<p class="text-muted">请从上方选择号码并添加到列表。</p>';
                }
            }
            // 更新趣味游戏提示
            updateFunGameTip(lotteryType);
        });

        updateDisplay(); // Initial display
    }

    // Setup for SSQ
    setupBallSelector('ssq', 33, 16);
    // Setup for DLT
    setupBallSelector('dlt', 35, 12);


    // Range slider for check range
    const ssqCheckRange = document.getElementById('ssq_check_range');
    const ssqCheckRangeDisplay = document.getElementById('ssq_check_range_display');
    const dltCheckRange = document.getElementById('dlt_check_range');
    const dltCheckRangeDisplay = document.getElementById('dlt_check_range_display');

    // 设置滑块的最大值
    const ssqTotalDraws = {{ ssq_total_draws | tojson }};
    const dltTotalDraws = {{ dlt_total_draws | tojson }};

    ssqCheckRange.max = ssqTotalDraws > 0 ? ssqTotalDraws : 100; // 如果没有数据，默认最大100
    dltCheckRange.max = dltTotalDraws > 0 ? dltTotalDraws : 100;

    // 初始化显示和更新函数
    function updateRangeDisplay(rangeElement, displayElement, totalDraws) {
        if (rangeElement.value == totalDraws) { // 当滑块值等于总期数时显示“全部”
            displayElement.textContent = '全部';
        } else {
            displayElement.textContent = rangeElement.value;
        }
    }

    ssqCheckRange.addEventListener('input', function() {
        updateRangeDisplay(this, ssqCheckRangeDisplay, ssqTotalDraws);
    });
    dltCheckRange.addEventListener('input', function() {
        updateRangeDisplay(this, dltCheckRangeDisplay, dltTotalDraws);
    });


    // Prize check logic
    async function checkPrizes(lotteryType) {
        const candidateEntries = document.querySelectorAll(`#${lotteryType}_candidate_list .candidate-entry`);
        if (candidateEntries.length === 0) {
            alert('请先添加要对奖的号码。');
            return;
        }

        const checkRange = document.getElementById(`${lotteryType}_check_range`).value;
        const prizeResultsDiv = document.getElementById(`${lotteryType}_prize_results`);
        prizeResultsDiv.innerHTML = '<p class="text-muted">对奖中...</p>';

        const combinations = [];
        candidateEntries.forEach(entry => {
            const redBalls = entry.querySelector('input[name="candidate_red_balls"]').value;
            const blueBalls = entry.querySelector('input[name="candidate_blue_balls"]').value;
            combinations.push({ red_balls: redBalls, blue_balls: blueBalls });
        });

        try {
            const response = await fetch('/api/check_prizes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lottery_type: lotteryType,
                    combinations: combinations,
                    check_range: checkRange
                })
            });
            const data = await response.json();

            if (data.error) {
                prizeResultsDiv.innerHTML = `<p class="text-danger">对奖失败: ${data.error}</p>`;
                return;
            }

            let html = '';
            data.results.forEach((result, index) => {
                html += `<h5>号码组合 ${index + 1}:</h5>`;
                html += `<p>红球: ${renderBalls(result.input_red_balls.split(',').map(Number), 'red')}</p>`;
                html += `<p>蓝球: ${renderBalls(result.input_blue_balls.split(',').map(Number), 'blue')}</p>`;
                html += `<p><strong>单次投注花费:</strong> ${result.cost_per_draw.toLocaleString()} 元 (共 ${result.total_bets_per_draw.toLocaleString()} 注)</p>`;
                
                // 显示总中奖注数和总中奖金额
                if (result.total_winning_bets > 0) {
                    html += `<p class="text-success"><strong>总中奖:</strong> 共中 ${result.total_winning_bets.toLocaleString()} 注, 总奖金 ${result.total_winning_amount.toLocaleString()} 元</p>`;
                } else {
                    html += `<p class="text-danger"><strong>总中奖:</strong> 未中奖</p>`;
                }

                // 显示统计范围、总花费和回报率
                const returnRateClass = result.return_rate >= 100 ? 'text-success' : (result.return_rate > 0 ? 'text-warning' : 'text-danger');
                html += `<p><strong>统计范围:</strong> 实际核对 ${result.actual_checked_draws_count.toLocaleString()} 期, <strong>总花费:</strong> ${result.total_cost_for_range.toLocaleString()} 元, <strong>回报率:</strong> <span class="${returnRateClass}">${result.return_rate}%</span></p>`;

                if (result.matches.length > 0) {
                    html += '<p><strong>中奖记录:</strong></p><ul>';
                    result.matches.forEach(match => {
                        html += `<li>第 ${match.issue} 期 (${match.draw_date}): <strong>${match.prize_level}</strong>, 中 ${match.prize_count.toLocaleString()} 注, 奖金: ${match.prize_amount} 元</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p>在指定期数范围内未中奖。</p>';
                }
                html += '<hr>';
            });
            prizeResultsDiv.innerHTML = html;

        } catch (error) {
            console.error('Error during prize check:', error);
            prizeResultsDiv.innerHTML = '<p class="text-danger">核对中奖失败。</p>';
        }
    }

    document.getElementById('ssq_check_prizes').addEventListener('click', () => checkPrizes('ssq'));
    document.getElementById('dlt_check_prizes').addEventListener('click', () => checkPrizes('dlt'));

    // Clear prize results button
    document.getElementById('ssq_clear_prize_results').addEventListener('click', function() {
        document.getElementById('ssq_prize_results').innerHTML = '<p class="text-muted">点击“核对中奖”按钮查看结果。</p>';
    });
    document.getElementById('dlt_clear_prize_results').addEventListener('click', function() {
        document.getElementById('dlt_prize_results').innerHTML = '<p class="text-muted">点击“核对中奖”按钮查看结果。</p>';
    });


    // Fun game logic
    async function startFunGame(lotteryType) {
        const candidateList = document.getElementById(`${lotteryType}_candidate_list`);
        const candidateEntries = candidateList.querySelectorAll('.candidate-entry');
        if (candidateEntries.length === 0) {
            alert('请先添加要参与游戏的号码。');
            return;
        }
        // 趣味游戏只使用列表中的第一个号码
        const firstCandidateEntry = candidateEntries[0];
        const redBalls = firstCandidateEntry.querySelector('input[name="candidate_red_balls"]').value;
        const blueBalls = firstCandidateEntry.querySelector('input[name="candidate_blue_balls"]').value;

        const funGameResultsDiv = document.getElementById(`${lotteryType}_fun_game_results`);
        const funGameProgressDiv = document.getElementById(`${lotteryType}_fun_game_progress`);
        const progressBar = funGameProgressDiv.querySelector('.progress-bar');
        const statusText = funGameProgressDiv.querySelector(`#${lotteryType}_fun_game_status`);
        const funGameStartBtn = document.getElementById(`${lotteryType}_fun_game_start`);

        funGameResultsDiv.innerHTML = ''; // 清空上次结果
        funGameProgressDiv.style.display = 'block'; // 显示进度条
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.textContent = '0%';
        statusText.textContent = '正在模拟第 0 期...';
        funGameStartBtn.disabled = true; // 禁用按钮防止重复点击

        let simulationInterval; // 用于更新进度条的定时器

        try {
            // 模拟进度条更新 (前端无法知道后端真实进度，这里做个假进度)
            let currentSimulatedCount = 0;
            const totalSimulations = {{ settings.get('fun_game_max_simulations', 1000000) }};
            const updateFrequency = 100; // 每100毫秒更新一次
            const updateStep = Math.max(1, Math.floor(totalSimulations / 200)); // 每次更新模拟的期数，确保进度条平滑且不会太快

            simulationInterval = setInterval(() => {
                currentSimulatedCount += updateStep;
                if (currentSimulatedCount > totalSimulations) {
                    currentSimulatedCount = totalSimulations;
                }
                const progressPercentage = (currentSimulatedCount / totalSimulations) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.setAttribute('aria-valuenow', progressPercentage);
                progressBar.textContent = `${Math.floor(progressPercentage)}%`;
                statusText.textContent = `正在模拟第 ${currentSimulatedCount.toLocaleString()} 期...`; // 格式化数字

                if (currentSimulatedCount >= totalSimulations) {
                    clearInterval(simulationInterval);
                }
            }, updateFrequency);


            const response = await fetch('/api/fun_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lottery_type: lotteryType,
                    combinations: [{ red_balls: redBalls, blue_balls: blueBalls }], // 只传递第一个组合
                    max_simulations: totalSimulations // 传递给后端
                })
            });
            const data = await response.json();

            clearInterval(simulationInterval); // 停止进度条更新
            funGameProgressDiv.style.display = 'none'; // 隐藏进度条
            funGameStartBtn.disabled = false; // 启用按钮

            if (data.error) {
                funGameResultsDiv.innerHTML = `<p class="text-danger">游戏模拟失败: ${data.error}</p>`;
                return;
            }

            let html = '';
            const result = data.results[0]; // 只处理第一个结果
            const costDetails = calculateCombinationCost(result.input_red_balls.length, result.input_blue_balls.length, lotteryType);
            
            html += `<h5>号码组合 1:</h5>`;
            html += `<p>红球: ${renderBalls(result.input_red_balls.map(Number), 'red')}</p>`;
            html += `<p>蓝球: ${renderBalls(result.input_blue_balls.map(Number), 'blue')}</p>`;
            html += `<p><strong>单次投注花费:</strong> ${costDetails.total_cost.toLocaleString()} 元 (共 ${costDetails.total_bets.toLocaleString()} 注)</p>`; // 显示单次投注花费
            
            if (result.first_prize_info) {
                html += `<p class="text-success">恭喜！在虚拟开奖中，您的号码在第 <strong>${result.first_prize_info.draw_count.toLocaleString()}</strong> 次开奖时中得一等奖！</p>`; // 格式化数字
                html += `<p>预计中奖时间: <strong>${result.first_prize_info.estimated_date}</strong></p>`;
                html += `<p>预计花费: <strong>${result.first_prize_info.estimated_cost}</strong> 元</p>`;
            } else {
                html += `<p class="text-danger">在模拟的 ${totalSimulations.toLocaleString()} 次内未中得一等奖。</p>`; // 修正这里，直接使用 totalSimulations 变量
            }
            html += `<p>总共中奖情况:</p><ul>`;
            // 遍历并显示按降序排列的奖项
            for (const prizeLevel in result.total_prizes) {
                html += `<li>${prizeLevel}: ${result.total_prizes[prizeLevel].toLocaleString()} 次</li>`; // 格式化数字
            }
            html += `</ul>`;
            html += '<hr>';
            funGameResultsDiv.innerHTML = html;

        } catch (error) {
            console.error('Error during fun game:', error);
            clearInterval(simulationInterval); // 确保清除定时器
            funGameProgressDiv.style.display = 'none'; // 隐藏进度条
            funGameStartBtn.disabled = false; // 启用按钮
            funGameResultsDiv.innerHTML = '<p class="text-danger">趣味游戏模拟失败。</p>';
        }
    }

    document.getElementById('ssq_fun_game_start').addEventListener('click', () => startFunGame('ssq'));
    document.getElementById('dlt_fun_game_start').addEventListener('click', () => startFunGame('dlt'));

    // 更新趣味游戏提示文本
    function updateFunGameTip(lotteryType) {
        const candidateList = document.getElementById(`${lotteryType}_candidate_list`);
        const funGameTipElement = document.getElementById(`${lotteryType}_fun_game_tip`);
        const firstCandidateEntry = candidateList.querySelector('.candidate-entry');

        if (firstCandidateEntry) {
            const redBalls = firstCandidateEntry.querySelector('input[name="candidate_red_balls"]').value.split(',').map(Number);
            const blueBalls = firstCandidateEntry.querySelector('input[name="candidate_blue_balls"]').value.split(',').map(Number);
            const costDetails = calculateCombinationCost(redBalls.length, blueBalls.length, lotteryType);

            funGameTipElement.innerHTML = `
                此号码可用于趣味游戏：<br>
                红球: ${renderBalls(redBalls, 'red')}<br>
                蓝球: ${renderBalls(blueBalls, 'blue')}<br>
                单次投注花费: ${costDetails.total_cost.toLocaleString()} 元 (共 ${costDetails.total_bets.toLocaleString()} 注)
                <br>看看这个号码多久能中一等奖！请准备好，时间正在流逝，大奖扑面而来！
            `;
        } else {
            funGameTipElement.innerHTML = `
                请从上方选择号码并添加到列表，列表中的第一个号码将用于趣味游戏。<br>
                看看这个号码多久能中一等奖！请准备好，时间正在流逝，大奖扑面而来！
            `;
        }
    }


    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure the correct tab is active on load
        document.getElementById('ssq_check_tab').click();
        // Update fun game tips on load
        updateFunGameTip('ssq');
        updateFunGameTip('dlt');

        // 初始化滑块显示
        updateRangeDisplay(ssqCheckRange, ssqCheckRangeDisplay, ssqTotalDraws);
        updateRangeDisplay(dltCheckRange, dltCheckRangeDisplay, dltTotalDraws);
    });
</script>
{% endblock %}
