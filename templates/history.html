<!-- templates/history.html -->
<!-- 版本: 1.0.4 - 添加统计区域和统计范围筛选 -->
{% extends "base.html" %}

{% from "components/lottery_balls.html" import display_balls %}

{% block title %}历史开奖数据{% endblock %}

{% block content %}
<h1 class="mb-4">历史开奖数据与统计</h1>
<div class="mb-3">
    <a href="{{ url_for('routes.history', lottery_type='ssq', per_page=per_page, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), stats_range=stats_range) }}" class="btn {% if lottery_type == 'ssq' %}btn-danger{% else %}btn-outline-danger{% endif %}">双色球</a>
    <a href="{{ url_for('routes.history', lottery_type='dlt', per_page=per_page, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), stats_range=stats_range) }}" class="btn {% if lottery_type == 'dlt' %}btn-primary{% else %}btn-outline-primary{% endif %}">大乐透</a>
</div>

<div class="card mb-4">
    <div class="card-header">筛选与统计</div>
    <div class="card-body">
        <form class="row g-3 align-items-center" method="GET" action="{{ url_for('routes.history') }}">
            <div class="col-md-3">
                <label for="start_date" class="form-label">开始日期</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-2">
                <label for="per_page_select" class="form-label">每页显示</label>
                <select class="form-select" id="per_page_select" name="per_page">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="stats_range_select" class="form-label">统计范围</label>
                <select class="form-select" id="stats_range_select" name="stats_range">
                    {% for option in stats_range_options %}
                        <option value="{{ option }}" {% if stats_range == option %}selected{% endif %}>
                            {% if option == 0 %}所有历史{% else %}最近 {{ option }} 期{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mt-auto">
                <button type="submit" class="btn btn-primary">筛选</button>
            </div>
            <input type="hidden" name="lottery_type" value="{{ lottery_type }}">
        </form>
        <hr>
        <h5>统计数据概览 <small class="text-muted">(基于当前筛选条件和最近 {{ total_stats_draws }} 期数据)</small></h5>
        <div class="row">
            <div class="col-md-6">
                <h6>红球统计</h6>
                <canvas id="redBallFrequencyChart"></canvas>
                <canvas id="redBallOmissionChart" class="mt-3"></canvas>
                <button class="btn btn-sm btn-outline-secondary mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#redBallDetails" aria-expanded="false" aria-controls="redBallDetails">
                    显示/隐藏红球详细数据
                </button>
                <div class="collapse mt-3" id="redBallDetails">
                    <div class="card card-body">
                        <h7>红球详细数据</h7>
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>号码</th>
                                    <th>出现次数</th>
                                    <th>频率 (%)</th>
                                    <th>当前遗漏</th>
                                    <th>最大遗漏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in red_stats %}
                                <tr {% if stat.current_omission > 0 and stat.current_omission >= (red_ball_range / 2) %}class="table-danger"{% elif stat.frequency_percentage > (100 / red_ball_range * 1.5) %}class="table-success"{% endif %}>
                                    <td>{{ stat.ball }}</td>
                                    <td>{{ stat.frequency_count }}</td>
                                    <td>{{ stat.frequency_percentage }}</td>
                                    <td>{{ stat.current_omission }}</td>
                                    <td>{{ stat.max_omission }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6>蓝球统计</h6>
                <canvas id="blueBallFrequencyChart"></canvas>
                <canvas id="blueBallOmissionChart" class="mt-3"></canvas>
                <button class="btn btn-sm btn-outline-secondary mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#blueBallDetails" aria-expanded="false" aria-controls="blueBallDetails">
                    显示/隐藏蓝球详细数据
                </button>
                <div class="collapse mt-3" id="blueBallDetails">
                    <div class="card card-body">
                        <h7>蓝球详细数据</h7>
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>号码</th>
                                    <th>出现次数</th>
                                    <th>频率 (%)</th>
                                    <th>当前遗漏</th>
                                    <th>最大遗漏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in blue_stats %}
                                <tr {% if stat.current_omission > 0 and stat.current_omission >= (blue_ball_range / 2) %}class="table-danger"{% elif stat.frequency_percentage > (100 / blue_ball_range * 1.5) %}class="table-success"{% endif %}>
                                    <td>{{ stat.ball }}</td>
                                    <td>{{ stat.frequency_count }}</td>
                                    <td>{{ stat.frequency_percentage }}</td>
                                    <td>{{ stat.current_omission }}</td>
                                    <td>{{ stat.max_omission }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover table-sm">
        <thead>
            <tr>
                <th>期号</th>
                <th>日期</th>
                <th>红球</th>
                <th>蓝球</th>
                <th>销售额</th>
                <th>奖池</th>
                <th>一等奖</th>
                <th>奇偶比</th>
                <th>和值</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for draw in draws_pagination.items %}
            <tr>
                <td>{{ draw.issue }}</td>
                <td>{{ draw.draw_date.strftime('%Y-%m-%d') }}</td>
                <td>
                    {{ display_balls(draw.get_red_balls_list(), 'red') }}
                </td>
                <td>
                    {{ display_balls(draw.get_blue_balls_list(), 'blue') }}
                </td>
                <td>{{ "{:,.0f}".format(draw.sales_amount) }}</td>
                <td>{{ "{:,.0f}".format(draw.prize_pool) }}</td>
                <td>{{ draw.first_prize_count }} 注 / {{ "{:,.0f}".format(draw.first_prize_amount) }} 元</td>
                {% set odd_count, even_count, red_sum = calculate_odd_even_sum(draw.red_balls) %}
                <td>{{ odd_count }}:{{ even_count }}</td>
                <td>{{ red_sum }}</td>
                <td>
                    <button class="btn btn-sm btn-info check-rule-btn" data-lottery-type="{{ lottery_type }}" data-issue="{{ draw.issue }}">
                        检查规则
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if draws_pagination.has_prev %}
        <li class="page-item"><a class="page-link" href="{{ url_for('routes.history', page=draws_pagination.prev_num, per_page=per_page, lottery_type=lottery_type, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), stats_range=stats_range) }}">上一页</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">上一页</span></li>
        {% endif %}

        {% for p in draws_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
                {% if p == draws_pagination.page %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('routes.history', page=p, per_page=per_page, lottery_type=lottery_type, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), stats_range=stats_range) }}">{{ p }}</a></li>
                {% endif %}
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}

        {% if draws_pagination.has_next %}
        <li class="page-item"><a class="page-link" href="{{ url_for('routes.history', page=draws_pagination.next_num, per_page=per_page, lottery_type=lottery_type, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), stats_range=stats_range) }}">下一页</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">下一页</span></li>
        {% endif %}
    </ul>
</nav>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 规则检查按钮逻辑 (保持不变) ---
        document.querySelectorAll('.check-rule-btn').forEach(button => {
            button.addEventListener('click', function() {
                const lotteryType = this.dataset.lotteryType;
                const issue = this.dataset.issue;

                fetch(`/api/check_rules?lottery_type=${lotteryType}&issue=${issue}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { 
                                throw new Error(err.message || err.error || '服务器错误'); 
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        let message = `检查 ${lotteryType} 第 ${issue} 期规则结果：\n\n`;
                        if (data.error) {
                            message += `错误: ${data.message || data.error}`;
                        } else {
                            let passedRules = [];
                            let failedRules = [];
                            for (const ruleName in data) {
                                const rule = data[ruleName];
                                if (rule.passed) {
                                    passedRules.push(rule.message);
                                } else {
                                    failedRules.push(rule.message);
                                }
                            }
                            if (passedRules.length > 0) {
                                message += "符合规则:\n" + passedRules.join('\n') + "\n\n";
                            }
                            if (failedRules.length > 0) {
                                message += "不符合规则:\n" + failedRules.join('\n') + "\n";
                            }
                            if (passedRules.length === 0 && failedRules.length === 0) {
                                message += "没有可用的规则检查结果。";
                            }
                        }
                        alert(message);
                        console.log('规则检查结果:', data);
                    })
                    .catch(error => {
                        console.error('规则检查请求失败:', error);
                        alert(`规则检查失败: ${error.message || error}`);
                    });
            });
        });

        // --- 统计图表渲染逻辑 ---
        const redStats = {{ red_stats | tojson }};
        const blueStats = {{ blue_stats | tojson }};
        const redBallRange = {{ red_ball_range }};
        const blueBallRange = {{ blue_ball_range }};

        // 红球图表数据准备
        const redLabels = Array.from({length: redBallRange}, (_, i) => i + 1);
        const redFrequencyData = redStats.map(s => s.frequency_count);
        const redOmissionData = redStats.map(s => s.current_omission);

        // 蓝球图表数据准备
        const blueLabels = Array.from({length: blueBallRange}, (_, i) => i + 1);
        const blueFrequencyData = blueStats.map(s => s.frequency_count);
        const blueOmissionData = blueStats.map(s => s.current_omission);

        // 渲染红球出现频率图
        new Chart(document.getElementById('redBallFrequencyChart'), {
            type: 'bar',
            data: {
                labels: redLabels,
                datasets: [{
                    label: '红球出现次数',
                    data: redFrequencyData,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)', // Bootstrap danger color
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '红球出现频率'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '红球号码'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '出现次数'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        // 渲染红球遗漏期数图
        new Chart(document.getElementById('redBallOmissionChart'), {
            type: 'bar',
            data: {
                labels: redLabels,
                datasets: [{
                    label: '红球当前遗漏期数',
                    data: redOmissionData,
                    backgroundColor: 'rgba(13, 110, 253, 0.7)', // Bootstrap primary color
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '红球当前遗漏期数'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '红球号码'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '遗漏期数'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        // 渲染蓝球出现频率图
        new Chart(document.getElementById('blueBallFrequencyChart'), {
            type: 'bar',
            data: {
                labels: blueLabels,
                datasets: [{
                    label: '蓝球出现次数',
                    data: blueFrequencyData,
                    backgroundColor: 'rgba(0, 123, 255, 0.7)', // Blue
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '蓝球出现频率'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '蓝球号码'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '出现次数'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        // 渲染蓝球遗漏期数图
        new Chart(document.getElementById('blueBallOmissionChart'), {
            type: 'bar',
            data: {
                labels: blueLabels,
                datasets: [{
                    label: '蓝球当前遗漏期数',
                    data: blueOmissionData,
                    backgroundColor: 'rgba(108, 117, 125, 0.7)', // Grey
                    borderColor: 'rgba(108, 117, 125, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '蓝球当前遗漏期数'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '蓝球号码'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '遗漏期数'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}
