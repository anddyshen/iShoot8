<!-- templates/admin/news_manage.html -->
<!-- 版本: 1.0.0 -->
{% extends "base.html" %}

{% block title %}新闻管理{% endblock %}

{% block content %}
<h1 class="mb-4">新闻管理</h1>

<div class="card mb-4">
    <div class="card-header">添加新文章</div>
    <div class="card-body">
        <form method="POST">
            <input type="hidden" name="action" value="add">
            <div class="mb-3">
                <label for="title" class="form-label">标题</label>
                <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
                <label for="image_url" class="form-label">图片URL (可选)</label>
                <input type="url" class="form-control" id="image_url" name="image_url">
            </div>
            <div class="mb-3">
                <label for="summary" class="form-label">摘要 (可选)</label>
                <textarea class="form-control" id="summary" name="summary" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label for="content" class="form-label">内容</label>
                <textarea class="form-control" id="content" name="content" rows="5" required></textarea>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="is_homepage_display" name="is_homepage_display">
                <label class="form-check-label" for="is_homepage_display">
                    在首页展示
                </label>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="is_public" name="is_public" checked>
                <label class="form-check-label" for="is_public">
                    在公共区域展示 (作为后备)
                </label>
            </div>
            <button type="submit" class="btn btn-success">添加文章</button>
        </form>
    </div>
</div>

<h2 class="mb-3">现有文章</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm">
        <thead>
            <tr>
                <th>ID</th>
                <th>标题</th>
                <th>摘要</th>
                <th>首页展示</th>
                <th>公共展示</th>
                <th>创建日期</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for news in news_list %}
            <tr>
                <td>{{ news.id }}</td>
                <td>{{ news.title }}</td>
                <td>{{ news.summary | truncate(50) }}</td>
                <td>{% if news.is_homepage_display %}<span class="badge bg-success">是</span>{% else %}<span class="badge bg-secondary">否</span>{% endif %}</td>
                <td>{% if news.is_public %}<span class="badge bg-success">是</span>{% else %}<span class="badge bg-secondary">否</span>{% endif %}</td>
                <td>{{ news.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-warning me-1" data-bs-toggle="modal" data-bs-target="#editNewsModal"
                            data-id="{{ news.id }}" data-title="{{ news.title }}" data-image-url="{{ news.image_url }}"
                            data-summary="{{ news.summary }}" data-content="{{ news.content }}"
                            data-is-homepage-display="{{ news.is_homepage_display }}" data-is-public="{{ news.is_public }}">
                        编辑
                    </button>
                    <form action="{{ url_for('admin_routes.admin_news_manage') }}" method="POST" class="d-inline">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="news_id" value="{{ news.id }}">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除这篇新闻吗？');">删除</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 编辑新闻的模态框 -->
<div class="modal fade" id="editNewsModal" tabindex="-1" aria-labelledby="editNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="news_id" id="edit_news_id">
                <div class="modal-header">
                    <h5 class="modal-title" id="editNewsModalLabel">编辑文章</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">标题</label>
                        <input type="text" class="form-control" id="edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_image_url" class="form-label">图片URL (可选)</label>
                        <input type="url" class="form-control" id="edit_image_url" name="image_url">
                    </div>
                    <div class="mb-3">
                        <label for="edit_summary" class="form-label">摘要 (可选)</label>
                        <textarea class="form-control" id="edit_summary" name="summary" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_content" class="form-label">内容</label>
                        <textarea class="form-control" id="edit_content" name="content" rows="5" required></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_is_homepage_display" name="is_homepage_display">
                        <label class="form-check-label" for="edit_is_homepage_display">
                            在首页展示
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_is_public" name="is_public">
                        <label class="form-check-label" for="edit_is_public">
                            在公共区域展示 (作为后备)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary">保存更改</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var editNewsModal = document.getElementById('editNewsModal');
        editNewsModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var id = button.getAttribute('data-id');
            var title = button.getAttribute('data-title');
            var imageUrl = button.getAttribute('data-image-url');
            var summary = button.getAttribute('data-summary');
            var content = button.getAttribute('data-content');
            var isHomepageDisplay = button.getAttribute('data-is-homepage-display') === 'True';
            var isPublic = button.getAttribute('data-is-public') === 'True';

            var modalTitle = editNewsModal.querySelector('.modal-title');
            var modalBodyInputId = editNewsModal.querySelector('#edit_news_id');
            var modalBodyInputTitle = editNewsModal.querySelector('#edit_title');
            var modalBodyInputImageUrl = editNewsModal.querySelector('#edit_image_url');
            var modalBodyInputSummary = editNewsModal.querySelector('#edit_summary');
            var modalBodyInputContent = editNewsModal.querySelector('#edit_content');
            var modalBodyInputIsHomepageDisplay = editNewsModal.querySelector('#edit_is_homepage_display');
            var modalBodyInputIsPublic = editNewsModal.querySelector('#edit_is_public');

            modalTitle.textContent = '编辑文章 #' + id;
            modalBodyInputId.value = id;
            modalBodyInputTitle.value = title;
            modalBodyInputImageUrl.value = imageUrl;
            modalBodyInputSummary.value = summary;
            modalBodyInputContent.value = content;
            modalBodyInputIsHomepageDisplay.checked = isHomepageDisplay;
            modalBodyInputIsPublic.checked = isPublic;
        });
    });
</script>
{% endblock %}
