<!-- templates/prediction.html -->
<!-- 版本: 1.0.6 - 修复遗漏号码排序问题，改为按遗漏期数从多到少排列 -->
{% extends "base.html" %}
{% from "components/lottery_balls.html" import display_balls %}

{% block title %}号码预测{% endblock %}

{% block head %}
<style>
    .ball-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
    }
    .lottery-ball-with-omission {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 10px; /* 调整间距 */
        margin-bottom: 5px;
    }
    .lottery-ball-with-omission .lottery-ball {
        margin-bottom: 2px; /* 球和遗漏期数之间的间距 */
    }
    .lottery-ball-with-omission .omission-text {
        font-size: 0.75em; /* 遗漏期数小字体 */
        color: #6c757d; /* 灰色 */
    }
    .rule-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .prediction-result-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .prediction-result-card .card-title {
        font-size: 1.1em;
        margin-bottom: 10px;
    }
    .prediction-result-card .ball-container {
        margin-bottom: 5px;
    }
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: #0d6efd;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { -webkit-transform: rotate(360deg); }
    }
    @-webkit-keyframes spin {
        to { -webkit-transform: rotate(360deg); }
    }
    /* 规则检查模态框样式 */
    .rule-check-modal-body .rule-item {
        margin-bottom: 5px;
        padding: 5px;
        border-radius: 3px;
    }
    .rule-check-modal-body .rule-item.passed {
        background-color: #d4edda; /* 绿色背景 */
        color: #155724; /* 深绿色文字 */
    }
    .rule-check-modal-body .rule-item.failed {
        background-color: #f8d7da; /* 红色背景 */
        color: #721c24; /* 深红色文字 */
    }
</style>
<!-- 引入 Chart.js for the pie chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-4">号码预测</h1>

<div class="alert alert-info text-center" role="alert">
    本页面提供的号码预测仅供娱乐参考，不构成任何投注建议。
</div>

<div class="mb-3">
    <a href="#" class="btn btn-danger active me-2" id="ssq_prediction_tab">双色球预测</a>
    <a href="#" class="btn btn-primary" id="dlt_prediction_tab">大乐透预测</a>
</div>

<div id="ssq_prediction_section" class="lottery-section">
    <h2 class="mb-3">双色球预测</h2>

    <!-- 最新开奖号码 -->
    <div class="card mb-4">
        <div class="card-header">最新 {{ settings.prediction_latest_draws }} 期开奖号码</div>
        <div class="card-body">
            {% if latest_ssq_draws %}
                {% for draw in latest_ssq_draws %}
                <p class="mb-1">
                    <strong>第 {{ draw.issue }} 期 ({{ draw.draw_date.strftime('%Y-%m-%d') }}):</strong>
                    红球: {{ display_balls(draw.get_red_balls_list(), 'red') }}
                    蓝球: {{ display_balls(draw.get_blue_balls_list(), 'blue') }}
                </p>
                {% endfor %}
            {% else %}
                <p>暂无最新双色球开奖数据。</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <!-- 预测规则文字 -->
            <div class="card mb-4">
                <div class="card-header">双色球预测规则</div>
                <div class="card-body rule-list">
                    <p><strong>4.1.1 蓝球规则:</strong> 蓝球如最新一期开出过的号码就不作为本期的预测候选号码，蓝球连续{{ settings.ssq_blue_consecutive_3_prob }}期开出此号码则此号码候选池内的出现的概率为{{ settings.ssq_blue_consecutive_3_prob * 100 }}%，如果连续{{ settings.ssq_blue_consecutive_5_prob }}期开出同样的蓝球号码，则此号码候选池内的出现的概率为{{ settings.ssq_blue_consecutive_5_prob * 100 }}%。</p>
                    <p><strong>4.1.2 红球遗漏权重:</strong> 红球最近未开出号码连续遗漏次数的第1多的号码数字作为候选球池中的一员，权重占 {{ settings.ssq_red_omit_1_weight * 100 }}%，第2多占{{ settings.ssq_red_omit_2_weight * 100 }}%，第3多占{{ settings.ssq_red_omit_3_weight * 100 }}%，第4多占{{ settings.ssq_red_omit_4_weight * 100 }}%，第5多占{{ settings.ssq_red_omit_5_weight * 100 }}%，第6多占{{ settings.ssq_red_omit_6_weight * 100 }}%。其他所有号码数字占比加起来平分剩下的百分比。</p>
                    <p><strong>4.1.3 红球重复概率:</strong> 如果红球最新开奖号码中的某一个号码连续开出重复3期及以上，则这个号码在候选号码池中的概率增加到{{ settings.ssq_red_consecutive_3_prob * 100 }}%，第二个重复3期以上的号码，概率增加到{{ settings.ssq_red_consecutive_3_second_prob * 100 }}%，其他号码概率平分剩下的百分比。</p>
                    <p><strong>4.1.4 红球区域分布:</strong> 将数字区间[1-8]、[9-16]、[17-24]、[25-33]作为4个区域，候选红球的数字区域分布大于等于 {{ settings.ssq_red_area_min_count }}个数字区间。</p>
                    <p><strong>4.1.5 红球重复限制:</strong> 红球预测的号码中的数字与前2期的开奖结果重复的号码加起来不超过{{ settings.ssq_red_prev_2_draws_max_repeat }}个。</p>
                    <p><strong>4.1.6 红球连号限制:</strong> 红球球不出现连续{{ settings.ssq_red_max_consecutive_balls + 1 }}个及以上数字的号码。</p>
                    <p><strong>4.1.10 红球遗漏降权:</strong> 红球若遗漏超过{{ settings.ssq_red_omit_12_prob }}期，则该号码在整个组合中出现的概率降至{{ settings.ssq_red_omit_12_prob * 100 }}%，红球若遗漏超过{{ settings.ssq_red_omit_13_prob }}期，则该号码在整个组合中出现的概率降至{{ settings.ssq_red_omit_13_prob * 100 }}%，红球若遗漏超过{{ settings.ssq_red_omit_14_prob }}期，则该号码在整个组合中出现的概率降至{{ settings.ssq_red_omit_14_prob * 100 }}%。</p>
                    <p><strong>4.5 规则冲突优先级:</strong> 所有规则如果产生冲突，则按照顺序作为优先级，在先的优先考虑，舍弃后一条规则。</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <!-- 遗漏期数最多的号码 -->
            <div class="card mb-4">
                <div class="card-header">遗漏期数最多的号码</div>
                <div class="card-body">
                    <p><strong>红球 (遗漏最多的 {{ settings.prediction_omitted_red_balls }} 个):</strong></p>
                    <div class="ball-container" id="ssq_omitted_red_balls">
                        <p class="text-muted">加载中... <span class="loading-spinner"></span></p>
                    </div>
                    <p><strong>蓝球 (遗漏最多的 {{ settings.prediction_omitted_blue_balls }} 个):</strong></p>
                    <div class="ball-container" id="ssq_omitted_blue_balls">
                        <p class="text-muted">加载中... <span class="loading-spinner"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 生成号码区域 -->
    <div class="card mb-4">
        <div class="card-header">生成预测号码</div>
        <div class="card-body">
            <div class="mb-3 row align-items-center">
                <label for="ssq_num_generate" class="col-sm-3 col-form-label">生成号码组数:</label>
                <div class="col-sm-3">
                    <input type="number" class="form-control" id="ssq_num_generate" value="{{ settings.prediction_generated_count }}" min="1" max="50">
                </div>
                <div class="col-sm-6">
                    <button class="btn btn-success me-2" id="generate_ssq_prediction">生成规则号码</button> <!-- 文本修改 -->
                    <button class="btn btn-info me-2" id="generate_ssq_random">生成真随机号码</button>
                    <button class="btn btn-secondary" id="clear_ssq_generated_numbers">清除生成的号码</button> <!-- 新增按钮 -->
                </div>
            </div>

            <hr>

            <h5>规则预测号码 (单式)</h5> <!-- 标题修改 -->
            <div id="ssq_predicted_numbers_output">
                <!-- 预测号码将在此处动态生成 -->
                <p class="text-muted">点击“生成规则号码”按钮。</p>
            </div>

            <h5 class="mt-4">真随机号码</h5>
            <div id="ssq_random_numbers_output">
                <!-- 随机号码将在此处动态生成 -->
                <p class="text-muted">点击“生成真随机号码”按钮。</p>
            </div>

            <hr>

            <!-- 复式预测功能 (4.3) -->
            <h5 class="mt-4">双色球复式预测 (4.3)</h5>
            <div class="mb-3 row align-items-center">
                <label for="ssq_complex_red_count" class="col-sm-3 col-form-label">红球数量 (7-20):</label>
                <div class="col-sm-2">
                    <input type="number" class="form-control" id="ssq_complex_red_count" value="7" min="7" max="20">
                </div>
                <label for="ssq_complex_blue_count" class="col-sm-3 col-form-label">蓝球数量 (1-16):</label>
                <div class="col-sm-2">
                    <input type="number" class="form-control" id="ssq_complex_blue_count" value="1" min="1" max="16">
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-warning" id="generate_ssq_complex_prediction">生成复式号码</button>
                </div>
            </div>
            <div id="ssq_complex_prediction_output">
                <p class="text-muted">复式号码将在此处生成。</p>
            </div>
        </div>
    </div>

    <!-- 组合数及筛选饼状图 (移动到最下方) -->
    <div class="card mb-4">
        <div class="card-header">组合筛选概览</div>
        <div class="card-body">
            <p>总组合数: <span id="ssq_total_combinations">计算中...</span></p>
            <p>通过规则筛选掉的可能: <span id="ssq_filtered_combinations">计算中...</span></p>
            <p>中奖的可能性: <span id="ssq_winning_chance">计算中...</span></p>
            <p>节省费用: <span id="ssq_saved_cost">计算中...</span> 元</p>
            <canvas id="ssq_filter_chart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<div id="dlt_prediction_section" class="lottery-section" style="display: none;">
    <h2 class="mb-3">大乐透预测</h2>

    <!-- 最新开奖号码 -->
    <div class="card mb-4">
        <div class="card-header">最新 {{ settings.prediction_latest_draws }} 期开奖号码</div>
        <div class="card-body">
            {% if latest_dlt_draws %}
                {% for draw in latest_dlt_draws %}
                <p class="mb-1">
                    <strong>第 {{ draw.issue }} 期 ({{ draw.draw_date.strftime('%Y-%m-%d') }}):</strong>
                    红球: {{ display_balls(draw.get_red_balls_list(), 'red') }}
                    蓝球: {{ display_balls(draw.get_blue_balls_list(), 'blue') }}
                </p>
                {% endfor %}
            {% else %}
                <p>暂无最新大乐透开奖数据。</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <!-- 预测规则文字 -->
            <div class="card mb-4">
                <div class="card-header">大乐透预测规则</div>
                <div class="card-body rule-list">
                    <p><strong>4.2.1 蓝球规则:</strong> 如果与最新一期的蓝球重复，则重复的每个号码数字在候选池中的出现概率不超过{{ settings.dlt_blue_repeat_prob * 100 }}%。如果任何一个蓝球号码连续5期开出，则此号码候选池内的出现的概率为{{ settings.dlt_blue_consecutive_5_prob * 100 }}%。</p>
                    <p><strong>4.2.2 红球遗漏优先权重:</strong> 在整个红球号码池中，红球未开出的连续遗漏次数的第[1]多的号码数字作为候选球池中的一员，权重占 [1%] ，连续遗漏数字第[2]的号码多占[1.5]% ，连续遗漏第[3]多的占 [2%]，连续遗漏第[4]多的占 [3%]，连续遗漏第[5]多的占 [3%]，其他所有号码数字占比加起来平分剩下的百分比 。因为大乐透红球中奖信息为5+2所以只统计前5多的号码，如果有重复造成大于5则把多出的当第6或第7个数字进行计算，以此类推。比如红球连续遗漏期数最多的前6个号码，权重分别为1%、1.5%、2%、3%、3%、3%（总计13.5%），剩余86.5%平分给33-6=27个球（每球≈3.2%）。</p>
                    <p><strong>4.2.3 红球重复高概率:</strong> 如果红球最新开奖号码中的某一个号码连续开出重复[3]期及以上，则这个号码在候选号码池中的概率增加到{{ settings.dlt_red_consecutive_3_prob * 100 }}%，其他号码概率平分剩下的百分比。</p>
                    <p><strong>4.2.4 红球区域分布:</strong> 将数字区间[1-8]、[9-16]、[17-24]、[25-35]作为4个区域，候选红球的数字区域分布大于等于 {{ settings.dlt_red_area_min_count }}个数字区间。</p>
                    <p><strong>4.2.5 红球重复限制:</strong> 红球预测的号码中的数字与前2期的开奖结果重复的号码加起来不超过{{ settings.dlt_red_prev_2_draws_max_repeat }}个。</p>
                    <p><strong>4.2.6 红球连号限制:</strong> 红球球不出现连续{{ settings.dlt_red_max_consecutive_balls + 1 }}个及以上数字的号码。</p>
                    <p><strong>4.2.10 红球遗漏降权:</strong> 红球若遗漏超过{{ settings.dlt_red_omit_12_prob }}期，则该号码在整个组合中出现的概率降至{{ settings.dlt_red_omit_12_prob * 100 }}%，红球若遗漏超过{{ settings.dlt_red_omit_13_prob }}期，则该号码在整个组合中出现的概率降至{{ settings.dlt_red_omit_13_prob * 100 }}%，红球若遗漏超过{{ settings.dlt_red_omit_14_prob }}期，则该号码在整个组合中出现的概率降至{{ settings.dlt_red_omit_14_prob * 100 }}%。</p>
                    <p><strong>4.5 规则冲突优先级:</strong> 所有规则如果产生冲突，则按照顺序作为优先级，在先的优先考虑，舍弃后一条规则。</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <!-- 遗漏期数最多的号码 -->
            <div class="card mb-4">
                <div class="card-header">遗漏期数最多的号码</div>
                <div class="card-body">
                    <p><strong>红球 (遗漏最多的 {{ settings.prediction_omitted_red_balls }} 个):</strong></p>
                    <div class="ball-container" id="dlt_omitted_red_balls">
                        <p class="text-muted">加载中... <span class="loading-spinner"></span></p>
                    </div>
                    <p><strong>蓝球 (遗漏最多的 {{ settings.prediction_omitted_blue_balls }} 个):</strong></p>
                    <div class="ball-container" id="dlt_omitted_blue_balls">
                        <p class="text-muted">加载中... <span class="loading-spinner"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 生成号码区域 -->
    <div class="card mb-4">
        <div class="card-header">生成预测号码</div>
        <div class="card-body">
            <div class="mb-3 row align-items-center">
                <label for="dlt_num_generate" class="col-sm-3 col-form-label">生成号码组数:</label>
                <div class="col-sm-3">
                    <input type="number" class="form-control" id="dlt_num_generate" value="{{ settings.prediction_generated_count }}" min="1" max="50">
                </div>
                <div class="col-sm-6">
                    <button class="btn btn-success me-2" id="generate_dlt_prediction">生成规则号码</button> <!-- 文本修改 -->
                    <button class="btn btn-info me-2" id="generate_dlt_random">生成真随机号码</button>
                    <button class="btn btn-secondary" id="clear_dlt_generated_numbers">清除生成的号码</button> <!-- 新增按钮 -->
                </div>
            </div>

            <hr>

            <h5>规则预测号码 (单式)</h5> <!-- 标题修改 -->
            <div id="dlt_predicted_numbers_output">
                <!-- 预测号码将在此处动态生成 -->
                <p class="text-muted">点击“生成规则号码”按钮。</p>
            </div>

            <h5 class="mt-4">真随机号码</h5>
            <div id="dlt_random_numbers_output">
                <!-- 随机号码将在此处动态生成 -->
                <p class="text-muted">点击“生成真随机号码”按钮。</p>
            </div>

            <hr>

            <!-- 复式预测功能 (4.3) -->
            <h5 class="mt-4">大乐透复式预测 (4.3)</h5>
            <div class="mb-3 row align-items-center">
                <label for="dlt_complex_red_count" class="col-sm-3 col-form-label">红球数量 (6-20):</label>
                <div class="col-sm-2">
                    <input type="number" class="form-control" id="dlt_complex_red_count" value="6" min="6" max="20">
                </div>
                <label for="dlt_complex_blue_count" class="col-sm-3 col-form-label">蓝球数量 (1-12):</label>
                <div class="col-sm-2">
                    <input type="number" class="form-control" id="dlt_complex_blue_count" value="1" min="1" max="12">
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-warning" id="generate_dlt_complex_prediction">生成复式号码</button>
                </div>
            </div>
            <div id="dlt_complex_prediction_output">
                <p class="text-muted">复式号码将在此处生成。</p>
            </div>
        </div>
    </div>

    <!-- 组合数及筛选饼状图 (移动到最下方) -->
    <div class="card mb-4">
        <div class="card-header">组合筛选概览</div>
        <div class="card-body">
            <p>总组合数: <span id="dlt_total_combinations">计算中...</span></p>
            <p>通过规则筛选掉的可能: <span id="dlt_filtered_combinations">计算中...</span></p>
            <p>中奖的可能性: <span id="dlt_winning_chance">计算中...</span></p>
            <p>节省费用: <span id="dlt_saved_cost">计算中...</span> 元</p>
            <canvas id="dlt_filter_chart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Rule Check Modal -->
<div class="modal fade" id="ruleCheckModal" tabindex="-1" aria-labelledby="ruleCheckModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleCheckModalLabel">号码规则检查结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body rule-check-modal-body">
                <!-- 规则检查结果将在此处动态加载 -->
                <p class="text-muted">加载中...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- 确保在自定义脚本之前加载 Bootstrap 的 JS，特别是 Modal 组件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Function to render lottery balls (replicated from Jinja macro for JS use)
    function renderBalls(balls, ballType) {
        let html = '';
        const sortedBalls = [...balls].sort((a, b) => a - b);
        for (const ball of sortedBalls) {
            html += `<span class="lottery-ball ball-${ballType}">${String(ball).padStart(2, '0')}</span>`;
        }
        return html;
    }

    // New function to render balls with omission count
    function renderBallsWithOmission(ballsWithOmission, ballType) {
        let html = '';
        // 移除前端的二次排序，因为后端已经按遗漏期数降序排列
        // const sortedBalls = [...ballsWithOmission].sort((a, b) => a.ball - b.ball); 
        for (const ballData of ballsWithOmission) { // 直接使用后端返回的已排序数据
            html += `
                <div class="lottery-ball-with-omission">
                    <span class="lottery-ball ball-${ballType}">${String(ballData.ball).padStart(2, '0')}</span>
                    <small class="omission-text">遗漏${ballData.current_omission}</small>
                </div>
            `;
        }
        return html;
    }

    // Tab switching logic
    document.getElementById('ssq_prediction_tab').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('ssq_prediction_section').style.display = 'block';
        document.getElementById('dlt_prediction_section').style.display = 'none';
        this.classList.add('active');
        document.getElementById('dlt_prediction_tab').classList.remove('active');
        console.log("Switched to SSQ tab. Loading omitted balls for SSQ.");
        loadOmittedBalls('ssq'); // Load data for SSQ when tab is clicked
    });

    document.getElementById('dlt_prediction_tab').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('dlt_prediction_section').style.display = 'block';
        document.getElementById('ssq_prediction_section').style.display = 'none';
        this.classList.add('active');
        document.getElementById('ssq_prediction_tab').classList.remove('active');
        console.log("Switched to DLT tab. Loading omitted balls for DLT.");
        loadOmittedBalls('dlt'); // Load data for DLT when tab is clicked
    });

    // Load omitted balls via API
    async function loadOmittedBalls(lotteryType) {
        const redContainer = document.getElementById(`${lotteryType}_omitted_red_balls`);
        const blueContainer = document.getElementById(`${lotteryType}_omitted_blue_balls`);
        
        redContainer.innerHTML = '<p class="text-muted">加载中... <span class="loading-spinner"></span></p>';
        blueContainer.innerHTML = '<p class="text-muted">加载中... <span class="loading-spinner"></span></p>';

        console.log(`Frontend: Fetching omitted balls for ${lotteryType}...`);
        try {
            const response = await fetch(`/api/prediction/omitted_balls?lottery_type=${lotteryType}`);
            const data = await response.json();

            console.log(`Frontend: Received response for ${lotteryType} omitted balls:`, data);

            if (data.error) {
                redContainer.innerHTML = `<p class="text-danger">加载失败: ${data.error}</p>`;
                blueContainer.innerHTML = `<p class="text-danger">加载失败: ${data.error}</p>`;
                return;
            }

            // Use the new renderBallsWithOmission function
            redContainer.innerHTML = renderBallsWithOmission(data.red_balls, 'red');
            blueContainer.innerHTML = renderBallsWithOmission(data.blue_balls, 'blue');
            console.log(`Frontend: Successfully rendered omitted balls for ${lotteryType}.`);

        } catch (error) {
            console.error(`Frontend: Error loading omitted balls for ${lotteryType}:`, error);
            redContainer.innerHTML = '<p class="text-danger">加载失败。</p>';
            blueContainer.innerHTML = '<p class="text-danger">加载失败。</p>';
        }
    }

    // Generate Random Numbers
    async function generateRandomNumbers(lotteryType) {
        const numGenerate = document.getElementById(`${lotteryType}_num_generate`).value;
        const outputDiv = document.getElementById(`${lotteryType}_random_numbers_output`);
        outputDiv.innerHTML = '<p class="text-muted">生成中... <span class="loading-spinner"></span></p>';

        console.log(`Frontend: Generating random numbers for ${lotteryType}, count: ${numGenerate}...`);
        try {
            const response = await fetch('/api/prediction/generate_random', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lottery_type: lotteryType, count: parseInt(numGenerate) })
            });
            const data = await response.json();

            console.log(`Frontend: Received response for ${lotteryType} random numbers:`, data);

            if (data.error) {
                outputDiv.innerHTML = `<p class="text-danger">生成失败: ${data.error}</p>`;
                return;
            }

            let html = '';
            data.numbers.forEach((combo, index) => {
                html += `<div class="prediction-result-card">
                            <p class="card-title">随机号码 ${index + 1}:</p>
                            <p>红球: ${renderBalls(combo.red_balls.split(',').map(Number), 'red')}</p>
                            <p>蓝球: ${renderBalls(combo.blue_balls.split(',').map(Number), 'blue')}</p>
                            <button class="btn btn-sm btn-outline-info me-2 regenerate-random-btn" data-lottery-type="${lotteryType}" data-index="${index}">重新生成</button>
                            <button class="btn btn-sm btn-outline-primary check-generated-rules-btn" data-lottery-type="${lotteryType}" data-red-balls="${combo.red_balls}" data-blue-balls="${combo.blue_balls}">检查规则</button>
                            <div class="rule-check-results mt-2" id="${lotteryType}_random_rule_check_${index}"></div>
                        </div>`;
            });
            outputDiv.innerHTML = html;
            console.log(`Frontend: Successfully rendered random numbers for ${lotteryType}.`);

        } catch (error) {
            console.error(`Frontend: Error generating random numbers for ${lotteryType}:`, error);
            outputDiv.innerHTML = '<p class="text-danger">生成失败。</p>';
        }
    }

    // Generate Predicted Numbers (now "规则号码")
    async function generatePredictedNumbers(lotteryType) {
        const numGenerate = document.getElementById(`${lotteryType}_num_generate`).value;
        const outputDiv = document.getElementById(`${lotteryType}_predicted_numbers_output`);
        outputDiv.innerHTML = '<p class="text-muted">生成中... <span class="loading-spinner"></span></p>';

        console.log(`Frontend: Generating predicted (rule-based) numbers for ${lotteryType}, count: ${numGenerate}...`);
        try {
            const response = await fetch('/api/prediction/generate_predicted', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lottery_type: lotteryType, count: parseInt(numGenerate) })
            });
            const data = await response.json();

            console.log(`Frontend: Received response for ${lotteryType} predicted numbers:`, data);

            if (data.error) {
                outputDiv.innerHTML = `<p class="text-danger">生成失败: ${data.error}</p>`;
                return;
            }

            let html = '';
            data.numbers.forEach((combo, index) => {
                html += `<div class="prediction-result-card">
                            <p class="card-title">规则预测号码 ${index + 1}:</p>
                            <p>红球: ${renderBalls(combo.red_balls.split(',').map(Number), 'red')}</p>
                            <p>蓝球: ${renderBalls(combo.blue_balls.split(',').map(Number), 'blue')}</p>
                            <button class="btn btn-sm btn-outline-info me-2 regenerate-predicted-btn" data-lottery-type="${lotteryType}" data-index="${index}">重新生成</button>
                            <button class="btn btn-sm btn-outline-primary check-generated-rules-btn" data-lottery-type="${lotteryType}" data-red-balls="${combo.red_balls}" data-blue-balls="${combo.blue_balls}">检查规则</button>
                            <div class="rule-check-results mt-2" id="${lotteryType}_predicted_rule_check_${index}"></div>
                        </div>`;
            });
            outputDiv.innerHTML = html;
            console.log(`Frontend: Successfully rendered predicted numbers for ${lotteryType}.`);

        } catch (error) {
            console.error(`Frontend: Error generating predicted numbers for ${lotteryType}:`, error);
            outputDiv.innerHTML = '<p class="text-danger">生成失败。</p>';
        }
    }

    // Check Rules for Generated Numbers (using new API)
    async function checkGeneratedRules(lotteryType, redBallsStr, blueBallsStr) {
        const modalBody = document.querySelector('#ruleCheckModal .modal-body'); // Output to modal body
        modalBody.innerHTML = '<p class="text-muted">检查中... <span class="loading-spinner"></span></p>';
        const ruleCheckModal = new bootstrap.Modal(document.getElementById('ruleCheckModal'));
        ruleCheckModal.show(); // Show modal immediately

        console.log(`Frontend: Checking rules for generated numbers for ${lotteryType}: Red=${redBallsStr}, Blue=${blueBallsStr}`);
        try {
            const response = await fetch('/api/prediction/check_generated_rules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    lottery_type: lotteryType, 
                    red_balls: redBallsStr, 
                    blue_balls: blueBallsStr 
                })
            });
            const data = await response.json();

            console.log(`Frontend: Received rule check response for ${lotteryType}:`, data);

            if (data.error) {
                modalBody.innerHTML = `<p class="text-danger">规则检查失败: ${data.error}</p>`;
                return;
            }

            let html = '';
            for (const ruleKey in data) {
                const ruleResult = data[ruleKey];
                const statusClass = ruleResult.passed ? 'passed' : 'failed';
                html += `<div class="rule-item ${statusClass}">
                            <strong>${ruleKey}:</strong> ${ruleResult.message}
                        </div>`;
            }
            modalBody.innerHTML = html;

        } catch (error) {
            console.error(`Frontend: Error checking rules for generated numbers for ${lotteryType}:`, error);
            modalBody.innerHTML = '<p class="text-danger">规则检查失败。</p>';
        }
    }

    // Clear Generated Numbers
    function clearGeneratedNumbers(lotteryType) {
        document.getElementById(`${lotteryType}_predicted_numbers_output`).innerHTML = '<p class="text-muted">点击“生成规则号码”按钮。</p>';
        document.getElementById(`${lotteryType}_random_numbers_output`).innerHTML = '<p class="text-muted">点击“生成真随机号码”按钮。</p>';
        console.log(`Frontend: Cleared generated numbers for ${lotteryType}.`);
    }


    // Event Listeners
    document.getElementById('generate_ssq_random').addEventListener('click', () => generateRandomNumbers('ssq'));
    document.getElementById('generate_dlt_random').addEventListener('click', () => generateRandomNumbers('dlt'));

    document.getElementById('generate_ssq_prediction').addEventListener('click', () => generatePredictedNumbers('ssq'));
    document.getElementById('generate_dlt_prediction').addEventListener('click', () => generatePredictedNumbers('dlt'));

    // Clear buttons
    document.getElementById('clear_ssq_generated_numbers').addEventListener('click', () => clearGeneratedNumbers('ssq'));
    document.getElementById('clear_dlt_generated_numbers').addEventListener('click', () => clearGeneratedNumbers('dlt'));


    // Event delegation for dynamically added "重新生成" and "检查规则" buttons
    document.getElementById('ssq_random_numbers_output').addEventListener('click', function(e) {
        if (e.target.classList.contains('regenerate-random-btn')) {
            generateRandomNumbers(e.target.dataset.lotteryType); 
        }
        if (e.target.classList.contains('check-generated-rules-btn')) {
            checkGeneratedRules(e.target.dataset.lotteryType, e.target.dataset.redBalls, e.target.dataset.blueBalls);
        }
    });
    document.getElementById('dlt_random_numbers_output').addEventListener('click', function(e) {
        if (e.target.classList.contains('regenerate-random-btn')) {
            generateRandomNumbers(e.target.dataset.lotteryType);
        }
        if (e.target.classList.contains('check-generated-rules-btn')) {
            checkGeneratedRules(e.target.dataset.lotteryType, e.target.dataset.redBalls, e.target.dataset.blueBalls);
        }
    });

    document.getElementById('ssq_predicted_numbers_output').addEventListener('click', function(e) {
        if (e.target.classList.contains('regenerate-predicted-btn')) {
            generatePredictedNumbers(e.target.dataset.lotteryType);
        }
        if (e.target.classList.contains('check-generated-rules-btn')) {
            checkGeneratedRules(e.target.dataset.lotteryType, e.target.dataset.redBalls, e.target.dataset.blueBalls);
        }
    });
    document.getElementById('dlt_predicted_numbers_output').addEventListener('click', function(e) {
        if (e.target.classList.contains('regenerate-predicted-btn')) {
            generatePredictedNumbers(e.target.dataset.lotteryType);
        }
        if (e.target.classList.contains('check-generated-rules-btn')) {
            checkGeneratedRules(e.target.dataset.lotteryType, e.target.dataset.redBalls, e.target.dataset.blueBalls);
        }
    });


    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure the correct tab is active on load
        document.getElementById('ssq_prediction_tab').click(); // This will also trigger loadOmittedBalls('ssq')
    });
</script>
{% endblock %}
